<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Terrænbooking Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+8gis3VnHjJvr2ohGhXwM5uvtGZfwP+9AUU29EK6E="
    crossorigin=""
  />
  <!-- Simple styling for layout -->
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      padding: 10px 15px;
      background: #004080;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.3rem;
    }
    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #sidebar {
      width: 320px;
      background: white;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
    }
    #map-container {
      flex: 1;
      position: relative;
      /* ensure map container fills remaining height */
      height: 100%;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background: #004080;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #002F66;
    }
    /* Modal style for booking form */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 400px;
      max-width: 90%;
      border-radius: 6px;
      position: relative;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Terrænbooking</h1>
      <div id="user-info"></div>
    </header>
    <main id="main-content" class="hidden">
      <aside id="sidebar">
        <h2>Bookingfiltre</h2>
        <!-- Filter: type of terrain (shooting range or exercise area) -->
        <label for="terrainTypeSelect">Type</label>
        <select id="terrainTypeSelect">
          <option value="all">Alle typer</option>
          <option value="skydebane">Skydebane</option>
          <option value="ovelsesterran">Øvelsesterræn</option>
        </select>
        <!-- Date input -->
        <label for="dateInput">Dato</label>
        <input type="date" id="dateInput" />
        <!-- Time slot input (from and to) -->
        <label for="startTimeInput">Starttid</label>
        <input type="time" id="startTimeInput" />
        <label for="endTimeInput">Sluttid</label>
        <input type="time" id="endTimeInput" />
        <!-- Location dropdown (populated from markers) -->
        <label for="locationSelect">Sted</label>
        <select id="locationSelect">
          <option value="">Vælg sted</option>
        </select>
        <button id="searchBtn">Søg</button>
        <!-- Booking summary will appear here -->
        <div id="bookingSummary"></div>
      </aside>
      <div id="map-container">
        <div id="map"></div>
      </div>
    </main>
  </div>

  <!-- Booking form modal -->
  <div id="bookingModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-btn" id="closeModal">×</button>
      <h2>Book terræn</h2>
      <form id="bookingForm">
        <input type="hidden" id="modalLocation" />
        <label for="modalActivity">Aktivitet</label>
        <select id="modalActivity" required>
          <option value="">Vælg aktivitet</option>
        </select>
        <label for="modalUnitType">Enhedstype</label>
        <select id="modalUnitType" required>
          <option value="INF">INF (Infanteri)</option>
          <option value="MEKINF">MEKINF (Mekaniseret INF)</option>
          <option value="PNINF">PNINF (Panser INF)</option>
          <option value="KVG">KVG (Kampvogne)</option>
        </select>
        <label for="modalDate">Dato</label>
        <input type="date" id="modalDate" required />
        <label for="modalStart">Starttid</label>
        <input type="time" id="modalStart" required />
        <label for="modalEnd">Sluttid</label>
        <input type="time" id="modalEnd" required />
        <!-- Additional fields for skydebane bookings -->
        <div id="ammoSection" class="hidden">
          <label for="modalAmmoType">Ammunitionstype</label>
          <select id="modalAmmoType">
            <option value="5.56">5.56 mm</option>
            <option value="7.62">7.62 mm</option>
            <option value="12.7">12.7 mm</option>
            <option value="IKK">IKK</option>
            <option value="KVG">KVG</option>
          </select>
          <label for="modalAmmoQty">Mængde ammunition</label>
          <input type="number" id="modalAmmoQty" min="0" />
        </div>
        <!-- Lodging and transport options -->
        <label for="modalLodging">Indkvartering</label>
        <select id="modalLodging">
          <option value="nej">Nej</option>
          <option value="ja">Ja</option>
        </select>
        <label for="modalTransport">Transport</label>
        <select id="modalTransport">
          <option value="nej">Nej</option>
          <option value="ja">Ja</option>
        </select>
        <button type="submit">Bekræft booking</button>
      </form>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-p2Jhgex7aWl/Wp0M45NrgYynZ6YfIxtlbkBIDiSiP9k="
    crossorigin=""
  ></script>
  <script>
    /**
     * Dette script opretter en simpel prototype af terrænbooking systemet.
     * Der er tre hoveddele:
     * 1. Login-step hvor brugeren indtaster sin MA (medarbejdernummer).
     * 2. Et delt hovedlayout med filtre og kort, hvor brugeren kan søge på
     *    type, dato, tidsrum og sted.
     * 3. En modal dialog der åbnes når man klikker på et terræn, hvor booking-
     *    detaljer kan angives og gemmes.
     *
     * Markerdata og bookingrestriktioner er forsimplet og har ikke
     * backend-persistens. Al booking gemmes kun i browserens hukommelse.
     */

    // Dummy user data – i en rigtig applikation skulle dette komme fra login.
    const users = {
      '460071': {
        name: 'Philip Andreas Hovgaard',
        position: 'NK KMP 1/V GHR'
      },
      '123456': {
        name: 'Test Bruger',
        position: 'Demo'
      }
    };

    // Markerdata med koordinater, navne og typer
    const markersData = [
      { id: 'slagelse', name: 'Slagelse Øvelsesterræn', type: 'ovelsesterran', lat: 55.404, lon: 11.353 },
      { id: 'jaegerspris', name: 'Jægerspris Skydeterræn', type: 'skydebane', lat: 55.908, lon: 12.076 },
      { id: 'odeby', name: 'Oddesund Øvelsesterræn', type: 'ovelsesterran', lat: 56.568, lon: 8.464 },
      { id: 'varde', name: 'Varde Skydeterræn', type: 'skydebane', lat: 55.623, lon: 8.484 },
      { id: 'aalborg', name: 'Aalborg Øvelsesterræn', type: 'ovelsesterran', lat: 56.997, lon: 9.814 },
      { id: 'hevring', name: 'Hevring Skydeterræn', type: 'skydebane', lat: 56.524, lon: 10.646 },
      { id: 'bornholm', name: 'Bornholm Øvelsesterræn', type: 'ovelsesterran', lat: 55.121, lon: 14.970 },
      { id: 'jyde', name: 'Oksbøl Øvelsesterræn', type: 'ovelsesterran', lat: 55.600, lon: 8.289 },
      { id: 'skive', name: 'Skive Skydeterræn', type: 'skydebane', lat: 56.560, lon: 9.027 },
      { id: 'vejle', name: 'Børkop Øvelsesterræn', type: 'ovelsesterran', lat: 55.659, lon: 9.712 }
    ];

    // Bookingstorage: simple in-memory array
    const bookings = [];

    // Populate location dropdown
    function populateLocationOptions() {
      const select = document.getElementById('locationSelect');
      // remove existing dynamic options
      select.querySelectorAll('option:not([value=""])').forEach(opt => opt.remove());
      markersData.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        select.appendChild(opt);
      });
    }

    // Filter markers based on selected type
    function updateMarkersVisibility(type) {
      markers.forEach(({ marker, data }) => {
        if (type === 'all' || data.type === type) {
          marker.addTo(map);
        } else {
          marker.remove();
        }
      });
    }

    // On page load: show login prompt
    window.addEventListener('DOMContentLoaded', () => {
      // Show login prompt via simple prompt
      let ma = prompt('Indtast dit MA (medarbejdernummer)');
      const userInfoDiv = document.getElementById('user-info');
      const mainContent = document.getElementById('main-content');
      if (ma && users[ma]) {
        const user = users[ma];
        userInfoDiv.textContent = `${user.name} – ${user.position}`;
        mainContent.classList.remove('hidden');
        initApp();
      } else {
        userInfoDiv.textContent = 'Ukendt bruger';
      }
    });

    // Main application logic
    let map;
    let markers = [];
    function initApp() {
      populateLocationOptions();
      // Initialize map
      map = L.map('map').setView([56.2639, 9.5018], 6.3); // center Denmark
      // Use Wikimedia tiles (free and accessible) instead of default OSM tiles
      L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap contributors, Wikimedia Maps'
      }).addTo(map);
      // Create markers
      markers = markersData.map(data => {
        const marker = L.marker([data.lat, data.lon]).addTo(map);
        marker.bindTooltip(data.name);
        marker.on('click', () => openBookingModal(data));
        return { marker, data };
      });
      // Listen to filter changes
      document.getElementById('terrainTypeSelect').addEventListener('change', e => {
        updateMarkersVisibility(e.target.value);
      });
      document.getElementById('searchBtn').addEventListener('click', handleSearch);
      document.getElementById('closeModal').addEventListener('click', () => toggleModal(false));
      document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);
    }

    // Search button handler: highlight markers matching filters
    function handleSearch() {
      const type = document.getElementById('terrainTypeSelect').value;
      const date = document.getElementById('dateInput').value;
      const start = document.getElementById('startTimeInput').value;
      const end = document.getElementById('endTimeInput').value;
      const loc = document.getElementById('locationSelect').value;
      // first, reset all markers
      markers.forEach(({ marker }) => {
        marker.setIcon(new L.Icon.Default());
      });
      // update marker visibility according to type
      updateMarkersVisibility(type);
      // highlight selected location if any
      if (loc) {
        const found = markers.find(m => m.data.id === loc);
        if (found) {
          found.marker.openPopup();
          // use a green marker icon to highlight available
          const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          });
          found.marker.setIcon(greenIcon);
          // zoom to marker
          map.setView(found.marker.getLatLng(), 12);
        }
      }
      // simple check for missing date/time
      if (!date || !start || !end) {
        document.getElementById('bookingSummary').textContent = 'Angiv dato og tidsrum for at se tilgængelighed.';
        return;
      }
      // for simplicity, we assume all markers are available; highlight accordingly
      markers.forEach(({ marker }) => {
        // skip if removed due to type filter
        if (!map.hasLayer(marker)) return;
        const greenIcon = new L.Icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });
        marker.setIcon(greenIcon);
      });
      document.getElementById('bookingSummary').textContent = 'Alle valgte områder er ledige i det angivne tidsrum (MVP). Klik på et marker for at booke.';
    }

    // Open modal and populate fields based on marker data
    function openBookingModal(data) {
      // Prefill location
      document.getElementById('modalLocation').value = data.id;
      // Setup activity options based on type
      const activitySelect = document.getElementById('modalActivity');
      activitySelect.innerHTML = '<option value="">Vælg aktivitet</option>';
      if (data.type === 'skydebane') {
        // Only shooting range booking allowed
        const opt = document.createElement('option');
        opt.value = 'Skydebane';
        opt.textContent = 'Skydebane';
        activitySelect.appendChild(opt);
        document.getElementById('ammoSection').classList.remove('hidden');
      } else {
        // Options for exercise area
        ['Øvelse', 'Enhedsuddannelse'].forEach(text => {
          const opt = document.createElement('option');
          opt.value = text;
          opt.textContent = text;
          activitySelect.appendChild(opt);
        });
        document.getElementById('ammoSection').classList.add('hidden');
      }
      // Prefill date/time if user entered them in filters
      document.getElementById('modalDate').value = document.getElementById('dateInput').value;
      document.getElementById('modalStart').value = document.getElementById('startTimeInput').value;
      document.getElementById('modalEnd').value = document.getElementById('endTimeInput').value;
      toggleModal(true);
    }

    // Toggle modal visibility
    function toggleModal(show) {
      const modal = document.getElementById('bookingModal');
      if (show) modal.classList.remove('hidden');
      else modal.classList.add('hidden');
    }

    // Handle booking form submission
    function handleBookingSubmit(e) {
      e.preventDefault();
      // Gather data
      const locationId = document.getElementById('modalLocation').value;
      const location = markersData.find(m => m.id === locationId);
      const activity = document.getElementById('modalActivity').value;
      const unit = document.getElementById('modalUnitType').value;
      const date = document.getElementById('modalDate').value;
      const start = document.getElementById('modalStart').value;
      const end = document.getElementById('modalEnd').value;
      const ammoType = document.getElementById('modalAmmoType').value;
      const ammoQty = document.getElementById('modalAmmoQty').value;
      const lodging = document.getElementById('modalLodging').value;
      const transport = document.getElementById('modalTransport').value;
      // Simple validation: ensure date is not today or past
      const today = new Date();
      const selectedDate = new Date(date);
      if (selectedDate <= today) {
        alert('Du kan ikke booke samme dag eller tidligere. Vælg en fremtidig dato.');
        return;
      }
      // Save booking
      const booking = {
        location: location.name,
        type: location.type,
        activity,
        unit,
        date,
        start,
        end,
        ammoType: location.type === 'skydebane' ? ammoType : null,
        ammoQty: location.type === 'skydebane' ? ammoQty : null,
        lodging,
        transport
      };
      bookings.push(booking);
      toggleModal(false);
      // Show confirmation in sidebar
      const summary = document.getElementById('bookingSummary');
      summary.innerHTML = `<strong>Booking bekræftet:</strong><br>
        Terræn: ${booking.location}<br>
        Aktivitet: ${booking.activity}<br>
        Enhedstype: ${booking.unit}<br>
        Dato: ${booking.date}<br>
        Tid: ${booking.start} - ${booking.end}<br>
        ${booking.ammoType ? 'Ammunition: ' + booking.ammoType + ' (' + booking.ammoQty + ')' + '<br>' : ''}
        Indkvartering: ${booking.lodging}<br>
        Transport: ${booking.transport}<br>
        `;
      alert('Booking gennemført! Se detaljer i boksen nedenfor.');
    }
  </script>
</body>
</html>